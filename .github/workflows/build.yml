name: Build & Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Build app
        run: |
          xcodebuild \
            -project iPadMirror.xcodeproj \
            -scheme "iPad Mirror" \
            -configuration Release \
            -derivedDataPath .build/xcode \
            build

      - name: Create DMG
        run: |
          APP_PATH=".build/xcode/Build/Products/Release/iPad Mirror.app"
          DMG_NAME="iPadMirror-${GITHUB_REF_NAME}.dmg"

          # Create a temporary directory for DMG contents
          mkdir -p dmg-staging
          cp -R "$APP_PATH" dmg-staging/
          ln -s /Applications dmg-staging/Applications

          # Create DMG
          hdiutil create \
            -volname "iPad Mirror" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            "$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.DMG_NAME }}
          generate_release_notes: true
